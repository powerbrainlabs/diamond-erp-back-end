version: '3.8'

services:
  # Backend API
  # Note: MongoDB and MinIO are running separately on the host
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: diamond-erp-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    # Memory limits for low RAM server (1GB total)
    # Backend gets 300MB with 50MB swap (will use system swap if needed)
    deploy:
      resources:
        limits:
          memory: 300M
        reservations:
          memory: 200M
    # Alternative: Use host network mode to access host services directly
    # Uncomment the line below and comment out networks if host.docker.internal doesn't work
    # network_mode: "host"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # MongoDB - connecting to host service
      # If using host network mode, use: mongodb://localhost:27017
      MONGODB_URL: ${MONGODB_URL:-mongodb://host.docker.internal:27017}
      DATABASE_NAME: diamond_erp
      
      # MinIO - connecting to host service
      # If using host network mode, use: localhost:9000
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-host.docker.internal:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_USE_TLS: "false"
      # Public host for presigned URLs (accessible from browser via nginx proxy - HTTPS)
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-staging.gac.powerbrainlabs.com}
      
      # JWT
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-this-in-production-min-16-chars}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7
      
      # CORS - Include staging domain and IP for access (HTTPS and HTTP)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://staging.gac.powerbrainlabs.com,http://staging.gac.powerbrainlabs.com,https://backend-sta.gac.powerbrainlabs.com,http://backend-sta.gac.powerbrainlabs.com,http://136.114.184.66,http://136.114.184.66:80,http://localhost:80,http://localhost:5173,http://localhost:3000}
      
      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@diamonderp.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Admin@123}
      ADMIN_NAME: ${ADMIN_NAME:-Administrator}
      
      # Frontend URL (HTTPS)
      FRONTEND_URL: ${FRONTEND_URL:-https://staging.gac.powerbrainlabs.com}
      
      # Remove.bg API
      REMOVE_BG_API_KEY: ${REMOVE_BG_API_KEY:-MXua93vfYeGxtuWoJv8xJEmE}
      REMOVE_BG_API_URL: https://api.remove.bg/v1.0/removebg
      
      # App settings
      APP_NAME: Diamond ERP API
      DEBUG: "true"
    networks:
      - erp-backend-network

networks:
  erp-backend-network:
    name: erp-backend-network
    driver: bridge

